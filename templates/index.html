{% extends "base.html" %}
{% block content %}

<form method="post" action="{{ url_for('index') }}" class="card shadow-sm">
  <div class="card-body">

    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <div class="label mb-1">Nome</div>
            <input class="form-control" name="nome" value="{{ pg.nome }}" onblur="this.form.submit()">
        </div>

        <div class="col-12 col-md-3">
            <div class="label mb-1">Lineage</div>
            <select class="form-select" name="lineage" onchange="this.form.submit()">
            {% for l in LINEAGES %}
                <option value="{{ l }}" {% if l == pg.lineage %}selected{% endif %}>{{ l }}</option>
            {% endfor %}
            </select>
        </div>

        <div class="col-12 col-md-3">
            <div class="label mb-1">Classe</div>
            <select class="form-select" name="classe" onchange="this.form.submit()">
            {% for c in CLASSES %}
                <option value="{{ c }}" {% if c == pg.classe %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
            </select>
        </div>

        <div class="col-6 col-md-1">
            <div class="label mb-1">Lv</div>
            <input class="form-control mono" type="number" min="1" max="20" name="level"
                value="{{ pg.level }}" onchange="this.form.submit()" onblur="this.form.submit()">
        </div>

        <div class="col-6 col-md-2">
            <div class="label mb-1">Allineamento</div>
            <select class="form-select" name="alignment" onchange="this.form.submit()">
            {% for a in ALIGNMENTS %}
                <option value="{{ a }}" {% if a == pg.alignment %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
            </select>
        </div>
    </div>


    {% if pg.lineage.startswith("Mezzelfo") %}
      <hr class="my-3">
      <div class="row g-2">
        <div class="col-12 col-md-4">
          <div class="label mb-1">Mezzelfo +1 #1</div>
          <select class="form-select" name="mezzelfo_0" onchange="this.form.submit()">
            <option value="">—</option>
            {% for code,label in mezzelfo_opts %}
              <option value="{{ code }}" {% if pg.lineage_extra_stats[0] == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <div class="label mb-1">Mezzelfo +1 #2</div>
          <select class="form-select" name="mezzelfo_1" onchange="this.form.submit()">
            <option value="">—</option>
            {% for code,label in mezzelfo_opts %}
              <option value="{{ code }}" {% if pg.lineage_extra_stats[1] == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4 small text-muted d-flex align-items-end">
          (non puoi scegliere CAR, e niente duplicati)
        </div>
      </div>
    {% endif %}

    <hr class="my-3">

    <div class="row g-2">
      <div class="col-12">
        <div class="label">Caratteristiche</div>
      </div>

      {% for s in STATS %}
        <div class="col-6 col-md-4 col-lg-2">
          <div class="border rounded p-2 bg-white">
            <div class="label">{{ STAT_LABEL[s] }}</div>

            <div class="d-flex justify-content-between align-items-center mt-1">
              <input class="form-control form-control-sm mono text-end" style="max-width:80px"
                type="number" min="3" max="20" name="stat_{{ s }}" value="{{ pg.stats_base[s] }}"
                onchange="this.form.submit()" onblur="this.form.submit()"
                onkeydown="if(event.key==='Enter'){event.preventDefault(); this.form.submit();}">

              <span class="small text-muted">bonus razza: {{ "%+d"|format(bonus.get(s, 0)) }}</span>
            </div>

            <div class="mt-2">
              <div class="small text-muted">Totale</div>
              <div class="value mono">{{ totals[s] }}</div>
            </div>

            <div class="small text-muted">
              Mod: <span class="mono value">{{ "%+d"|format((totals[s]-10)//2) }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <hr class="my-3">

    <div class="row g-2">
      <div class="col-12 col-md-4">
        <div class="border rounded p-2 bg-white">
          <div class="label">Bonus Competenza</div>
          <div class="value mono">+{{ pb }}</div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="border rounded p-2 bg-white">
          <div class="label">HP Max (auto)</div>
          <div class="value mono">{{ hpmax }}</div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="border rounded p-2 bg-white">
          <div class="label">Dado Vita</div>
          <div class="value mono">d{{ hit_die }}</div>
        </div>
      </div>
    </div>

    <hr class="my-3">

    <div class="row g-2">
      <div class="col-12">
        <div class="label">Abilità (Skills)</div>
        {% if choose_n > 0 %}
          <div class="small text-muted">Scegli {{ choose_n }} competenze</div>
        {% endif %}
      </div>
      <div class="col-12 col-md-4">
        <select class="form-select" name="skills_proficient" multiple size="10" onchange="this.form.submit()">
          {% for sk in allowed_skills %}
            <option value="{{ sk }}" {% if sk in pg.skills_proficient %}selected{% endif %}>{{ sk }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-8">
        <div class="border rounded p-2 bg-white">
          <div class="row g-2 small">
            {% for row in skill_rows %}
              <div class="col-12 col-md-6">
                <div class="d-flex justify-content-between">
                  <span>{{ row.name }} <span class="text-muted">({{ row.stat_label }})</span></span>
                  <span class="mono">{{ "%+d"|format(row.bonus) }} {% if row.proficient %}✅{% endif %}</span>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

  </div>
</form>

{% endblock %}
