{% extends "base.html" %}
{% block content %}

<form method="post" action="{{ url_for('index') }}" enctype="multipart/form-data" class="card shadow-sm">
  <div class="card-body">

    <div class="row g-2">
      <div class="col-12 col-lg-8">
        <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <div class="label mb-1">Nome</div>
                <input class="form-control" name="nome" value="{{ pg.nome }}" onblur="this.form.submit()">
            </div>

            <div class="col-12 col-md-2">
                <div class="label mb-1">Lineage</div>
                <select class="form-select" name="lineage" onchange="this.form.submit()">
                {% for l in LINEAGES %}
                    <option value="{{ l }}" {% if l == pg.lineage %}selected{% endif %}>{{ l }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="col-12 col-md-3">
                <div class="label mb-1">Classe</div>
                <select class="form-select" name="classe" onchange="this.form.submit()">
                {% for c in CLASSES %}
                    <option value="{{ c }}" {% if c == pg.classe %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="col-6 col-md-1">
                <div class="label mb-1">Lv</div>
                <input class="form-control mono" type="number" min="1" max="20" name="level"
                    value="{{ pg.level }}" onchange="this.form.submit()" onblur="this.form.submit()">
            </div>

            <div class="col-6 col-md-3">
                <div class="label mb-1">Allineamento</div>
                <select class="form-select" name="alignment" onchange="this.form.submit()">
                {% for a in ALIGNMENTS %}
                    <option value="{{ a }}" {% if a == pg.alignment %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
                </select>
            </div>
        </div>

        {% if pg.lineage.startswith("Mezzelfo") %}
          <hr class="my-3">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <div class="label mb-1">Mezzelfo +1 #1</div>
              <select class="form-select" name="mezzelfo_0" onchange="this.form.submit()">
                <option value="">-</option>
                {% for code,label in mezzelfo_opts %}
                  <option value="{{ code }}" {% if pg.lineage_extra_stats[0] == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4">
              <div class="label mb-1">Mezzelfo +1 #2</div>
              <select class="form-select" name="mezzelfo_1" onchange="this.form.submit()">
                <option value="">-</option>
                {% for code,label in mezzelfo_opts %}
                  <option value="{{ code }}" {% if pg.lineage_extra_stats[1] == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4 small text-muted d-flex align-items-end">
              (non puoi scegliere CAR, e niente duplicati)
            </div>
          </div>
        {% endif %}

        <hr class="my-3">
        <div class="label">Caratteristiche</div>
        <div class="d-flex gap-3 small mb-2 align-items-center">
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="stats_method"
              id="stats-method-manual"
              value="manual"
              {% if pg.stats_method == "manual" %}checked{% endif %}
              onchange="this.form.submit()"
            >
            <label class="form-check-label" for="stats-method-manual">Manuale</label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="stats_method"
              id="stats-method-standard"
              value="standard"
              {% if pg.stats_method == "standard" %}checked{% endif %}
              onchange="this.form.submit()"
            >
            <label class="form-check-label" for="stats-method-standard">Array standard</label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="stats_method"
              id="stats-method-point-buy"
              value="point_buy"
              {% if pg.stats_method == "point_buy" %}checked{% endif %}
              onchange="this.form.submit()"
            >
            <label class="form-check-label" for="stats-method-point-buy">Point Buy</label>
          </div>
          {% if pg.stats_method in ["standard", "point_buy"] %}
            <button type="submit" class="btn btn-sm btn-primary ms-2">Applica</button>
          {% endif %}
        </div>
        {% if pg.stats_method == "point_buy" %}
          <div class="small text-muted mb-2">
            Point Buy: spesi {{ point_buy_spent }} / {{ point_buy_total }} (rimasti {{ point_buy_remaining }})
          </div>
        {% endif %}
        <div class="row g-2">
          {% for s in STATS %}
            <div class="col-6 col-md-2">
              <div class="border rounded p-2 bg-white small h-100">
                <div class="label">{{ STAT_LABEL[s] }}</div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                  <span class="text-muted">Base</span>
                  {% if pg.stats_method == "standard" %}
                    <select
                      class="form-select form-select-sm mono text-end"
                      style="max-width:72px"
                      name="std_stat_{{ s }}"
                      data-std-select="1"
                    >
                      {% for v in standard_array_values %}
                        <option value="{{ v }}" {% if standard_assignment[s] == v %}selected{% endif %}>{{ v }}</option>
                      {% endfor %}
                    </select>
                  {% elif pg.stats_method == "point_buy" %}
                    <select
                      class="form-select form-select-sm mono text-end"
                      style="max-width:72px"
                      name="pb_stat_{{ s }}"
                    >
                      {% for v in point_buy_values %}
                        <option value="{{ v }}" {% if point_buy_assignment[s] == v %}selected{% endif %}>{{ v }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    <input
                      class="form-control form-control-sm mono text-end"
                      style="max-width:72px"
                      type="number"
                      min="1"
                      max="30"
                      name="stat_{{ s }}"
                      value="{{ sheet.base_stats[s] }}"
                      onchange="this.form.submit()"
                      onblur="this.form.submit()"
                      onkeydown="if(event.key==='Enter'){event.preventDefault(); this.form.submit();}"
                    >
                  {% endif %}
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">+Razza</span>
                  <span class="mono">{{ sheet.lineage_bonus.get(s, 0)|fmt_signed }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Tot</span>
                  <span class="mono fw-bold">{{ sheet.totals[s] }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">Mod</span>
                  <span class="mono">{{ sheet.mods[s]|fmt_signed }}</span>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-12">
            <div class="label">Abilit&agrave; (Skills)</div>
            {% if sheet.choose_n > 0 %}
              <div class="small text-muted">Scegli {{ sheet.choose_n }} competenze - Selezionate: {{ pg.skills_proficient|length }}/{{ sheet.choose_n }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <div class="row g-0 small">
              {% for row in sheet.skill_rows %}
                <div class="col-12 col-md-6 col-lg-4">
                  <div class="d-flex align-items-center justify-content-between py-1 px-1 border-bottom">
                    <div class="d-flex align-items-center gap-2">
                      {% if row.selectable %}
                        <input type="checkbox" class="form-check-input m-0"
                          name="skills_proficient" value="{{ row.name }}"
                          {% if row.proficient %}checked{% endif %}
                          onchange="onSkillToggle(this)">
                      {% endif %}
                      <span>
                        {{ row.name }} <span class="text-muted">({{ row.stat_label }})</span>
                      </span>
                      {% if row.proficient %}
                        <span class="text-success ms-1">&#10003;</span>
                      {% endif %}
                    </div>
                    <div class="mono fw-bold text-end" style="min-width:48px">
                      {{ "%+d"|format(row.bonus) }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <script>
              const LIMIT = Number("{{ sheet.choose_n|int }}");
              function onSkillToggle(cb) {
                if (!LIMIT) {
                  cb.form.submit();
                  return;
                }
                const checked = cb.form.querySelectorAll('input[name="skills_proficient"]:checked').length;
                if (checked > LIMIT) {
                  cb.checked = false;
                  return;
                }
                cb.form.submit();
              }
            </script>
            <script>
              (function () {
                function updateStdOptions() {
                  const selects = Array.from(document.querySelectorAll('select[data-std-select="1"]'));
                  if (!selects.length) return;

                  selects.forEach((sel) => {
                    const myValue = sel.value;
                    const usedElsewhere = new Set(
                      selects
                        .filter((other) => other !== sel)
                        .map((other) => other.value)
                        .filter((v) => v !== "" && v !== null)
                    );

                    Array.from(sel.options).forEach((opt) => {
                      opt.disabled = false;
                      if (usedElsewhere.has(opt.value) && opt.value !== myValue) {
                        opt.disabled = true;
                      }
                    });
                  });
                }

                document.addEventListener("DOMContentLoaded", function () {
                  const selects = document.querySelectorAll('select[data-std-select="1"]');
                  if (!selects.length) return;
                  updateStdOptions();
                  selects.forEach((sel) => sel.addEventListener("change", updateStdOptions));
                });
              })();
            </script>
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-12 {% if has_spell_slots_widget %}col-lg-8{% endif %}">
            <div class="border rounded p-2 bg-white summary small h-100">
              <div class="label">Riepilogo</div>
              <div class="row g-0">
                <div class="col-12 col-md-6">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Bonus Competenza</div>
                    <div class="mono fw-bold">{{ sheet.prof_bonus|fmt_signed }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 ps-md-2">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Percezione passiva</div>
                    <div class="mono fw-bold">{{ sheet.passive_perception }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Dado Vita</div>
                    <div class="mono fw-bold">d{{ sheet.hit_die }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 ps-md-2">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Iniziativa</div>
                    <div class="mono fw-bold">{{ sheet.initiative|fmt_signed }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Classe Armatura</div>
                    <div class="mono fw-bold">{{ sheet.ac }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 ps-md-2">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Velocit&agrave; (m)</div>
                    <div class="mono fw-bold">{{ sheet.speed_auto }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% if has_spell_slots_widget %}
            <div class="col-12 col-lg-4">
              <div class="border rounded p-2 bg-white summary small h-100">
                <div class="label">Slot Incantesimi</div>
                {% for row in spell_slot_rows %}
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">{{ row.level }}&deg;</div>
                    <div class="mono fw-bold">{{ row.current }} / {{ row.max }}</div>
                  </div>
                {% endfor %}
                {% if pact_slots_max > 0 %}
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Patto (Lv {{ pact_slot_level }})</div>
                    <div class="mono fw-bold">{{ pact_slots_current }} / {{ pact_slots_max }}</div>
                  </div>
                {% endif %}
                <div class="d-flex gap-2 mt-2">
                  <form method="post" action="{{ url_for('rest_spell_slots') }}" class="m-0">
                    <input type="hidden" name="character_id" value="{{ current_char_id }}">
                    <input type="hidden" name="rest_type" value="short">
                    <input type="hidden" name="next" value="{{ current_path }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit">Riposo breve</button>
                  </form>
                  <form method="post" action="{{ url_for('rest_spell_slots') }}" class="m-0">
                    <input type="hidden" name="character_id" value="{{ current_char_id }}">
                    <input type="hidden" name="rest_type" value="long">
                    <input type="hidden" name="next" value="{{ current_path }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit">Riposo lungo</button>
                  </form>
                </div>
              </div>
            </div>
          {% endif %}
        </div>

        <hr class="my-3">
        <div class="border rounded p-2 bg-white small">
          <div class="label">Difesa</div>
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-6 col-lg-5">
              <label class="text-muted mb-1">Armatura</label>
              <select class="form-select form-select-sm" name="armor_type" onchange="this.form.submit()">
                {% if "none" in sheet.allowed_armor %}<option value="none" {% if pg.armor_type == "none" %}selected{% endif %}>Nessuna</option>{% endif %}
                {% if "light" in sheet.allowed_armor %}<option value="light" {% if pg.armor_type == "light" %}selected{% endif %}>Leggera</option>{% endif %}
                {% if "medium" in sheet.allowed_armor %}<option value="medium" {% if pg.armor_type == "medium" %}selected{% endif %}>Media</option>{% endif %}
                {% if "heavy" in sheet.allowed_armor %}<option value="heavy" {% if pg.armor_type == "heavy" %}selected{% endif %}>Pesante</option>{% endif %}
              </select>
            </div>
            <div class="col-12 col-md-3 col-lg-3">
              <label class="text-muted mb-1 d-none d-md-block">&nbsp;</label>
              <div class="form-check mt-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="has-shield"
                  name="has_shield"
                  onchange="this.form.submit()"
                  {% if not sheet.shield_allowed %}disabled{% endif %}
                  {% if pg.has_shield %}checked{% endif %}
                >
                <label class="form-check-label text-muted" for="has-shield">Scudo (+2)</label>
              </div>
            </div>
            <div class="col-12 col-md-3 col-lg-4">
              <label class="text-muted mb-1">Bonus CA (Magie/Oggetti)</label>
              <input
                class="form-control form-control-sm mono text-end"
                style="max-width:120px"
                type="number"
                min="-10"
                max="10"
                name="ac_bonus"
                value="{{ pg.ac_bonus }}"
                onchange="this.form.submit()"
                onblur="this.form.submit()"
                onkeydown="if(event.key==='Enter'){event.preventDefault(); this.form.submit();}"
              >
            </div>
          </div>
        </div>

        <hr class="my-3">
        <div class="row g-2">
          <div class="col-12 {% if sheet.spellcasting.casting_ability %}col-lg-6{% endif %}">
            <div class="border rounded p-2 bg-white small">
              <div class="label">Attacchi</div>
              <div class="row g-0">
                <div class="col-12 col-md-6">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Mischia</div>
                    <div class="mono fw-bold">{{ "%+d"|format(sheet.melee_attack_bonus) }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 ps-md-2">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="form-check m-0">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="atk-prof-melee"
                        name="atk_prof_melee"
                        onchange="this.form.submit()"
                        {% if pg.atk_prof_melee %}checked{% endif %}
                      >
                      <label class="form-check-label text-muted" for="atk-prof-melee">Competente</label>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="text-muted">Distanza</div>
                    <div class="mono fw-bold">{{ "%+d"|format(sheet.ranged_attack_bonus) }}</div>
                  </div>
                </div>
                <div class="col-12 col-md-6 ps-md-2">
                  <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <div class="form-check m-0">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="atk-prof-ranged"
                        name="atk_prof_ranged"
                        onchange="this.form.submit()"
                        {% if pg.atk_prof_ranged %}checked{% endif %}
                      >
                      <label class="form-check-label text-muted" for="atk-prof-ranged">Competente</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% if sheet.spellcasting.casting_ability %}
            <div class="col-12 col-lg-6">
              <div class="border rounded p-2 bg-white">
                <div class="label">Incantesimi</div>
                <div class="row g-0 small">
                  <div class="col-12 col-md-6">
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                      <div class="text-muted">Abilit&agrave; da incantatore</div>
                      <div class="mono fw-bold">{{ sheet.spellcasting.ability_label }}</div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6 ps-md-2">
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                      <div class="text-muted">Mod incantatore</div>
                      <div class="mono fw-bold">{{ sheet.spellcasting.mod|fmt_signed }}</div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                      <div class="text-muted">Spell Save DC</div>
                      <div class="mono fw-bold">{{ sheet.spellcasting.spell_dc }}</div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6 ps-md-2">
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                      <div class="text-muted">Spell Attack</div>
                      <div class="mono fw-bold">{{ sheet.spellcasting.spell_attack_bonus|fmt_signed }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="border rounded p-2 bg-white small mb-2">
          <div class="label">Vita</div>
          <div class="row g-0">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <div class="text-muted">HP Max (auto)</div>
                <div class="mono fw-bold">{{ sheet.hpmax }}</div>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <div class="text-muted">HP Attuali</div>
                <input class="form-control form-control-sm mono text-end" style="max-width:120px"
                  type="number" min="0" max="999" name="hp_current" value="{{ pg.hp_current }}"
                  onchange="this.form.submit()" onblur="this.form.submit()"
                  onkeydown="if(event.key==='Enter'){event.preventDefault(); this.form.submit();}">
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <div class="text-muted">HP Temp</div>
                <input class="form-control form-control-sm mono text-end" style="max-width:120px"
                  type="number" min="0" max="999" name="hp_temp" value="{{ pg.hp_temp }}"
                  onchange="this.form.submit()" onblur="this.form.submit()"
                  onkeydown="if(event.key==='Enter'){event.preventDefault(); this.form.submit();}">
              </div>
            </div>
          </div>
        </div>
        <div class="border rounded p-2 bg-white">
          <div class="label">Tiri Salvezza</div>
          <div class="row g-1 small">
            {% for r in sheet.saving_rows %}
              <div class="col-6">
                <div class="d-flex justify-content-between">
                  <span>{{ STAT_LABEL[r.stat] }}</span>
                  <span class="mono">{{ "%+d"|format(r.bonus) }}</span>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

  </div>
</form>

{% endblock %}
