{% extends "base.html" %}
{% block content %}
{% set class_labels = {
  "bard": "Bardo",
  "cleric": "Chierico",
  "druid": "Druido",
  "paladin": "Paladino",
  "ranger": "Ranger",
  "sorcerer": "Stregone",
  "warlock": "Warlock",
  "wizard": "Mago"
} %}
{% set class_badge_order = ["bard", "cleric", "druid", "paladin", "ranger", "sorcerer", "warlock", "wizard"] %}

<div class="spells-page">
<div id="spells-ajax-alerts" class="mb-2"></div>
<div class="row g-3 mb-3 align-items-stretch">
  <div class="col-12 col-xl-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="label mb-2">Incantesimi</div>
        <form id="spells-filter-form" class="row g-2 align-items-end" method="get" action="{{ url_for('spells') }}">
          <div class="col-12 col-lg-5">
            <label class="text-muted mb-1">Cerca per nome</label>
            <input class="form-control form-control-sm" name="q" value="{{ q }}" placeholder="Es: dardo, cura, scudo">
          </div>
          <div class="col-6 col-lg-2">
            <label class="text-muted mb-1">Livello</label>
            <select class="form-select form-select-sm" name="level">
              <option value="">Tutti</option>
              {% for lv in range(0, 10) %}
                <option value="{{ lv }}" {% if level is not none and level == lv %}selected{% endif %}>
                  {% if lv == 0 %}Trucchetto{% else %}{{ lv }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6 col-lg-3">
            <label class="text-muted mb-1">Classe</label>
            <select class="form-select form-select-sm" name="class_code">
              <option value="">Tutte</option>
              {% for code in class_options %}
                <option value="{{ code }}" {% if class_code == code %}selected{% endif %}>{{ class_labels.get(code, code) }}</option>
              {% endfor %}
            </select>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" role="switch" id="pg-limits" name="pg_limits" value="1" {% if pg_limits %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="pg-limits">Usa limiti PG corrente</label>
            </div>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" role="switch" id="include-private" name="include_private" value="1" {% if include_private %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="include-private">Mostra contenuti privati</label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="ritual-only" name="ritual_only" value="1" {% if ritual_only %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="ritual-only">Solo rituali</label>
            </div>
            <div class="form-check mt-1">
              <input class="form-check-input" type="checkbox" id="concentration-only" name="concentration_only" value="1" {% if concentration_only %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="concentration-only">Solo concentrazione</label>
            </div>
          </div>
          <div class="col-12 col-lg-2">
            <div class="d-grid gap-2">
              <button id="spells-filter-submit" class="btn btn-sm btn-primary w-100" type="submit">Cerca</button>
              <button
                class="btn btn-sm btn-outline-secondary w-100"
                type="button"
                onclick="clearSpellsFilters()"
                {% if not q and level is none and not class_code and not pg_limits and not ritual_only and not concentration_only and not include_private %}disabled{% endif %}
              >
                Pulisci
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-4 d-flex">
    <div class="d-flex flex-column h-100 w-100">
      <div id="spell-slots-widget">
        {% with slots_widget_fill_height=False %}
          {% include "_spell_slots_widget.html" %}
        {% endwith %}
      </div>
      {% if spellcasting.casting_ability %}
        <div class="card shadow-sm mt-2 flex-grow-1">
          <div class="card-body py-2 px-2">
            <div class="label mb-1">Incantesimi</div>
            <div class="row g-0 small">
              <div class="col-12 col-md-6">
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                  <div class="text-muted">Caratteristica da incantatore</div>
                  <div class="mono fw-bold">{{ spellcasting.ability_label }}</div>
                </div>
              </div>
              <div class="col-12 col-md-6 ps-md-2">
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                  <div class="text-muted">Mod incantatore</div>
                  <div class="mono fw-bold">{{ spellcasting.mod|fmt_signed }}</div>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                  <div class="text-muted">CD Tiro Salvezza Incantesimi</div>
                  <div class="mono fw-bold">{{ spellcasting.spell_dc }}</div>
                </div>
              </div>
              <div class="col-12 col-md-6 ps-md-2">
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                  <div class="text-muted">Bonus Attacco Incantesimi</div>
                  <div class="mono fw-bold">{{ spellcasting.spell_attack_bonus|fmt_signed }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% if pg_limits %}
  <div class="alert alert-info py-2 mb-3 small">
    Filtro PG attivo:
    {% if pg_filter_class_label %}
      classe <strong>{{ pg_filter_class_label }}</strong>
    {% else %}
      classe non disponibile
    {% endif %}
    {% if pg_filter_max_spell_level is not none %}
      路 livello incantesimo massimo <strong>{{ pg_filter_max_spell_level }}</strong>
    {% endif %}
  </div>
{% endif %}

<div class="row g-3">
  <div class="col-12 col-lg-6" id="results-panel">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="label mb-2">Risultati</div>
        {% if not results %}
          <div class="text-muted small">Nessun risultato.</div>
        {% else %}
          <div class="list-group">
            {% for sp in results %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div>{{ sp.name }}</div>
                  <div class="text-muted small d-flex align-items-center gap-1 flex-wrap">
                    <span>Lv {{ sp.level }} 路 {{ sp.school }}</span>
                    {% if sp.ritual %}
                      <span class="badge rounded-pill text-bg-secondary" title="Rituale">R</span>
                    {% endif %}
                    {% if sp.concentration %}
                      <span class="badge rounded-pill text-bg-secondary" title="Concentrazione">C</span>
                    {% endif %}
                    {% if sp.origin == "private" %}
                      <span class="badge rounded-pill text-bg-warning-subtle border border-warning-subtle text-dark" title="Origine">Privato</span>
                    {% endif %}
                  </div>
                  {% if sp.class_codes %}
                    {% set codes = sp.class_codes.split(",") %}
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      {% for code in class_badge_order %}
                        {% if code in codes %}
                          <span class="badge rounded-pill text-bg-light border">{{ class_labels.get(code, code) }}</span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#spellDetailModal"
                    hx-get="/spell/{{ sp.id }}?origin={{ sp.origin|default('srd') }}"
                    hx-target="#spell-detail-body"
                    hx-swap="innerHTML"
                  >Dettagli</button>
                  <form method="post" action="{{ url_for('spells_add') }}" class="m-0 spell-action-form">
                    <input type="hidden" name="spell_id" value="{{ sp.id }}">
                    <input type="hidden" name="spell_origin" value="{{ sp.origin|default('srd') }}">
                    <input type="hidden" name="q" value="{{ q }}">
                    <input type="hidden" name="level" value="{{ level if level is not none else '' }}">
                    <input type="hidden" name="class_code" value="{{ class_code }}">
                    <input type="hidden" name="ritual_only" value="{{ '1' if ritual_only else '' }}">
                    <input type="hidden" name="concentration_only" value="{{ '1' if concentration_only else '' }}">
                    <input type="hidden" name="include_private" value="{{ '1' if include_private else '' }}">
                    <input type="hidden" name="pg_limits" value="{{ '1' if pg_limits else '' }}">
                    <input type="hidden" name="page" value="{{ page }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit" {% if sp.origin == "private" %}disabled title="Non disponibile per spell private"{% endif %}>Aggiungi</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
          {% if has_prev or has_next %}
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="small text-muted">Pagina {{ page }}</div>
              <div class="d-flex gap-2">
                {% if has_prev %}
                  <a
                    class="btn btn-sm btn-outline-secondary"
                    href="{{ url_for('spells', q=q, level=(level if level is not none else ''), class_code=class_code, ritual_only=('1' if ritual_only else ''), concentration_only=('1' if concentration_only else ''), include_private=('1' if include_private else ''), pg_limits=('1' if pg_limits else ''), page=page-1) }}"
                  >Precedente</a>
                {% endif %}
                {% if has_next %}
                  <a
                    class="btn btn-sm btn-outline-secondary"
                    href="{{ url_for('spells', q=q, level=(level if level is not none else ''), class_code=class_code, ritual_only=('1' if ritual_only else ''), concentration_only=('1' if concentration_only else ''), include_private=('1' if include_private else ''), pg_limits=('1' if pg_limits else ''), page=page+1) }}"
                  >Successiva</a>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6" id="owned-spells-panel">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="label mb-2">Incantesimi del personaggio</div>
        {% if not owned %}
          <div class="text-muted small">Nessun incantesimo aggiunto.</div>
        {% else %}
          <div class="list-group">
            {% for sp in owned %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div>{{ sp.name }}</div>
                  <div class="text-muted small d-flex align-items-center gap-1 flex-wrap">
                    <span>Lv {{ sp.level }} 路 {{ sp.school }}</span>
                    {% if sp.ritual %}
                      <span class="badge rounded-pill text-bg-secondary" title="Rituale">R</span>
                    {% endif %}
                    {% if sp.concentration %}
                      <span class="badge rounded-pill text-bg-secondary" title="Concentrazione">C</span>
                    {% endif %}
                  </div>
                  {% if sp.class_codes %}
                    {% set codes = sp.class_codes.split(",") %}
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      {% for code in class_badge_order %}
                        {% if code in codes %}
                          <span class="badge rounded-pill text-bg-light border">{{ class_labels.get(code, code) }}</span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#spellDetailModal"
                    hx-get="/spell/{{ sp.id }}?origin={{ sp.origin|default('srd') }}"
                    hx-target="#spell-detail-body"
                    hx-swap="innerHTML"
                  >Dettagli</button>
                  {% if sp.level == 0 %}
                    <form method="post" action="{{ url_for('spells_cast') }}" class="m-0 spell-action-form">
                      <input type="hidden" name="spell_name" value="{{ sp.name }}">
                      <input type="hidden" name="spell_level" value="{{ sp.level }}">
                      <input type="hidden" name="q" value="{{ q }}">
                      <input type="hidden" name="level" value="{{ level if level is not none else '' }}">
                      <input type="hidden" name="class_code" value="{{ class_code }}">
                      <input type="hidden" name="ritual_only" value="{{ '1' if ritual_only else '' }}">
                      <input type="hidden" name="concentration_only" value="{{ '1' if concentration_only else '' }}">
                      <input type="hidden" name="include_private" value="{{ '1' if include_private else '' }}">
                      <input type="hidden" name="pg_limits" value="{{ '1' if pg_limits else '' }}">
                      <input type="hidden" name="page" value="{{ page }}">
                      <button class="btn btn-sm btn-outline-success" type="submit">Lancia</button>
                    </form>
                  {% elif sp.cast_levels %}
                    <div class="d-flex align-items-center gap-1">
                      {% for cl in sp.cast_levels %}
                        <form method="post" action="{{ url_for('spells_cast') }}" class="m-0 spell-action-form">
                          <input type="hidden" name="spell_name" value="{{ sp.name }}">
                          <input type="hidden" name="spell_level" value="{{ sp.level }}">
                          <input type="hidden" name="cast_choice" value="{{ cl.value }}">
                          <input type="hidden" name="q" value="{{ q }}">
                          <input type="hidden" name="level" value="{{ level if level is not none else '' }}">
                          <input type="hidden" name="class_code" value="{{ class_code }}">
                          <input type="hidden" name="ritual_only" value="{{ '1' if ritual_only else '' }}">
                          <input type="hidden" name="concentration_only" value="{{ '1' if concentration_only else '' }}">
                          <input type="hidden" name="include_private" value="{{ '1' if include_private else '' }}">
                          <input type="hidden" name="pg_limits" value="{{ '1' if pg_limits else '' }}">
                          <input type="hidden" name="page" value="{{ page }}">
                          <button
                            class="btn btn-sm rounded-pill slot-level-chip {% if cl.rest == 'short' %}slot-level-chip--short{% else %}slot-level-chip--long{% endif %}{% if cl.remaining|int <= 0 %} slot-level-chip--empty{% endif %}"
                            type="submit"
                            title="{% if cl.rest == 'short' %}Riposo breve{% else %}Riposo lungo{% endif %} 路 {{ cl.remaining }} disponibili"
                            {% if cl.remaining|int <= 0 %}disabled{% endif %}
                          >{{ cl.label }}</button>
                        </form>
                      {% endfor %}
                    </div>
                  {% endif %}
                  <form method="post" action="{{ url_for('spells_remove') }}" class="m-0 spell-action-form">
                    <input type="hidden" name="spell_id" value="{{ sp.id }}">
                    <input type="hidden" name="q" value="{{ q }}">
                    <input type="hidden" name="level" value="{{ level if level is not none else '' }}">
                    <input type="hidden" name="class_code" value="{{ class_code }}">
                    <input type="hidden" name="ritual_only" value="{{ '1' if ritual_only else '' }}">
                    <input type="hidden" name="concentration_only" value="{{ '1' if concentration_only else '' }}">
                    <input type="hidden" name="include_private" value="{{ '1' if include_private else '' }}">
                    <input type="hidden" name="pg_limits" value="{{ '1' if pg_limits else '' }}">
                    <input type="hidden" name="page" value="{{ page }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Rimuovi</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="spellDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dettagli incantesimo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="spell-detail-body">
        <div class="text-muted small">Seleziona un incantesimo.</div>
      </div>
    </div>
  </div>
</div>

<script>
  async function refreshSpellSlotsWidget() {
    const target = document.getElementById('spell-slots-widget');
    if (!target) return;
    const response = await fetch("{{ url_for('spell_slots_widget') }}", {
      headers: { "X-Requested-With": "XMLHttpRequest" },
      cache: 'no-store'
    });
    if (!response.ok) return;
    target.innerHTML = await response.text();
  }

  async function refreshOwnedSpellsPanel() {
    const target = document.getElementById('owned-spells-panel');
    if (!target) return;
    const response = await fetch(window.location.pathname + window.location.search, {
      headers: { "X-Requested-With": "XMLHttpRequest" },
      cache: 'no-store'
    });
    if (!response.ok) return;
    const html = await response.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const fresh = doc.getElementById('owned-spells-panel');
    if (!fresh) return;
    target.innerHTML = fresh.innerHTML;
  }

  async function refreshSpellsPanelsAndAlerts() {
    const response = await fetch(window.location.pathname + window.location.search, {
      headers: { "X-Requested-With": "XMLHttpRequest" },
      cache: 'no-store'
    });
    if (!response.ok) return;
    const html = await response.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');

    const resultsTarget = document.getElementById('results-panel');
    const freshResults = doc.getElementById('results-panel');
    if (resultsTarget && freshResults) {
      resultsTarget.innerHTML = freshResults.innerHTML;
      if (window.htmx) {
        window.htmx.process(resultsTarget);
      }
    }

    const ownedTarget = document.getElementById('owned-spells-panel');
    const freshOwned = doc.getElementById('owned-spells-panel');
    if (ownedTarget && freshOwned) {
      ownedTarget.innerHTML = freshOwned.innerHTML;
      if (window.htmx) {
        window.htmx.process(ownedTarget);
      }
    }

    const alertsTarget = document.getElementById('spells-ajax-alerts');
    if (alertsTarget) {
      const flashAlerts = Array.from(doc.querySelectorAll('main > .alert.alert-success, main > .alert.alert-warning, main > .alert.alert-danger'));
      alertsTarget.innerHTML = flashAlerts.map((el) => el.outerHTML).join('');
    }
  }

  async function submitSpellSlotsFormAjax(form) {
    const body = new FormData(form);
    body.set('next', window.location.pathname + window.location.search);
    const response = await fetch(form.action, {
      method: 'POST',
      body,
      headers: { "X-Requested-With": "XMLHttpRequest" },
      cache: 'no-store'
    });
    if (!response.ok) {
      window.location.reload();
      return;
    }
    await refreshSpellSlotsWidget();
    await refreshOwnedSpellsPanel();
  }

  async function submitSpellActionFormAjax(form) {
    const body = new FormData(form);
    body.set('next', window.location.pathname + window.location.search);
    const response = await fetch(form.action, {
      method: 'POST',
      body,
      headers: { "X-Requested-With": "XMLHttpRequest" },
      cache: 'no-store'
    });
    if (!response.ok) {
      window.location.reload();
      return;
    }
    await refreshSpellSlotsWidget();
    await refreshSpellsPanelsAndAlerts();
  }

  document.addEventListener('submit', function (event) {
    const form = event.target;
    if (!(form instanceof HTMLFormElement)) return;
    if (form.classList.contains('slot-ajax-form')) {
      event.preventDefault();
      submitSpellSlotsFormAjax(form);
      return;
    }
    if (form.classList.contains('spell-action-form')) {
      event.preventDefault();
      submitSpellActionFormAjax(form);
    }
  });

  function updateClearSpellsFiltersState() {
    const form = document.getElementById('spells-filter-form');
    if (!form) return;
    const clearBtn = form.querySelector('button[onclick="clearSpellsFilters()"]');
    if (!clearBtn) return;

    const qInput = form.querySelector('input[name="q"]');
    const levelSelect = form.querySelector('select[name="level"]');
    const classSelect = form.querySelector('select[name="class_code"]');
    const ritualOnlyInput = form.querySelector('input[name="ritual_only"]');
    const concentrationOnlyInput = form.querySelector('input[name="concentration_only"]');
    const includePrivateInput = form.querySelector('input[name="include_private"]');
    const pgLimitsInput = form.querySelector('input[name="pg_limits"]');
    const hasQuery = Boolean(qInput && qInput.value.trim());
    const hasLevel = Boolean(levelSelect && levelSelect.value);
    const hasClass = Boolean(classSelect && classSelect.value);
    const hasRitualOnly = Boolean(ritualOnlyInput && ritualOnlyInput.checked);
    const hasConcentrationOnly = Boolean(concentrationOnlyInput && concentrationOnlyInput.checked);
    const hasIncludePrivate = Boolean(includePrivateInput && includePrivateInput.checked);
    const hasPgLimits = Boolean(pgLimitsInput && pgLimitsInput.checked);

    clearBtn.disabled = !(hasQuery || hasLevel || hasClass || hasRitualOnly || hasConcentrationOnly || hasIncludePrivate || hasPgLimits);
  }

  function clearSpellsFilters() {
    const form = document.getElementById('spells-filter-form');
    if (!form) return;

    const qInput = form.querySelector('input[name="q"]');
    const levelSelect = form.querySelector('select[name="level"]');
    const classSelect = form.querySelector('select[name="class_code"]');
    const ritualOnlyInput = form.querySelector('input[name="ritual_only"]');
    const concentrationOnlyInput = form.querySelector('input[name="concentration_only"]');
    const includePrivateInput = form.querySelector('input[name="include_private"]');
    const pgLimitsInput = form.querySelector('input[name="pg_limits"]');
    if (qInput) qInput.value = '';
    if (levelSelect) levelSelect.value = '';
    if (classSelect) classSelect.value = '';
    if (ritualOnlyInput) ritualOnlyInput.checked = false;
    if (concentrationOnlyInput) concentrationOnlyInput.checked = false;
    if (includePrivateInput) includePrivateInput.checked = false;
    if (pgLimitsInput) pgLimitsInput.checked = false;
    updateClearSpellsFiltersState();

    const submitBtn = document.getElementById('spells-filter-submit');
    if (submitBtn) {
      submitBtn.click();
      return;
    }
    form.requestSubmit();
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('spells-filter-form');
    if (!form) return;

    const qInput = form.querySelector('input[name="q"]');
    const levelSelect = form.querySelector('select[name="level"]');
    const classSelect = form.querySelector('select[name="class_code"]');
    const ritualOnlyInput = form.querySelector('input[name="ritual_only"]');
    const concentrationOnlyInput = form.querySelector('input[name="concentration_only"]');
    const includePrivateInput = form.querySelector('input[name="include_private"]');
    const pgLimitsInput = form.querySelector('input[name="pg_limits"]');
    if (qInput) qInput.addEventListener('input', updateClearSpellsFiltersState);
    if (levelSelect) levelSelect.addEventListener('change', updateClearSpellsFiltersState);
    if (classSelect) classSelect.addEventListener('change', updateClearSpellsFiltersState);
    if (ritualOnlyInput) ritualOnlyInput.addEventListener('change', updateClearSpellsFiltersState);
    if (concentrationOnlyInput) concentrationOnlyInput.addEventListener('change', updateClearSpellsFiltersState);
    if (includePrivateInput) includePrivateInput.addEventListener('change', updateClearSpellsFiltersState);
    if (pgLimitsInput) pgLimitsInput.addEventListener('change', updateClearSpellsFiltersState);

    updateClearSpellsFiltersState();
  });
</script>

</div>
{% endblock %}
